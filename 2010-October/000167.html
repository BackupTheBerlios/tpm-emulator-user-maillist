<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [tpm-emulator-user] TPM_SetCapability possibly broken in 0.7.1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/tpm-emulator-user/2010-October/index.html" >
   <LINK REL="made" HREF="mailto:tpm-emulator-user%40lists.berlios.de?Subject=Re%3A%20%5Btpm-emulator-user%5D%20TPM_SetCapability%20possibly%20broken%20in%200.7.1&In-Reply-To=%3C0016364578dc6c753e0491e5a805%40google.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000168.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[tpm-emulator-user] TPM_SetCapability possibly broken in 0.7.1</H1>
    <B>1.41421 at gmail.com</B> 
    <A HREF="mailto:tpm-emulator-user%40lists.berlios.de?Subject=Re%3A%20%5Btpm-emulator-user%5D%20TPM_SetCapability%20possibly%20broken%20in%200.7.1&In-Reply-To=%3C0016364578dc6c753e0491e5a805%40google.com%3E"
       TITLE="[tpm-emulator-user] TPM_SetCapability possibly broken in 0.7.1">1.41421 at gmail.com
       </A><BR>
    <I>Tue Oct  5 23:51:06 CEST 2010</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000168.html">[tpm-emulator-user] TPM_SetCapability possibly broken in 0.7.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#167">[ date ]</a>
              <a href="thread.html#167">[ thread ]</a>
              <a href="subject.html#167">[ subject ]</a>
              <a href="author.html#167">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I think that TPM_SetCapability may be broken in 0.7.1. Here is why.

I have a test environment with which I can send the following TCPA stream  
to the TPM emulator:

00 c2 00 00 00 48 00 00
00 3f 00 00 00 01 00 00
00 04 00 00 00 11 00 00
00 01 01 02 00 00 00 db
1c c5 46 49 92 55 7d 38
ff 18 ca e8 df ff 5d 0c
01 4c 20 00 fc 4b 23 0d
a1 44 57 d0 ea 1d 48 3d
fd 31 e2 27 1f a7 89 30

This is just the TCPA stream resulting from invoking the TPM_SetCapability  
command with some specific parameters. When receiving this stream, the  
emulator is able to parse it correctly but rejects it with an authorization  
failure error message - essentially, it claims that the authorization HMAC  
that it has received is incorrect.

According to the specs for this command, that HMAC is to be computed over  
the following inputs:

1) The SHA-1 hash computed over the concatenation of the command ordinal,  
the input capability area, the input subcapability size, the input  
subcapability data, the input set value size and the input set value data.

2) The even nonce.

3) The odd nonce.

4) The authorization session continuation Boolean.

The key for the HMAC computation is the owner's authorization data.

Looking into the TPM emulator with a debugger, at the point at which the  
incoming HMAC is to be verified (function tpm_verify_auth()) parameters 2,  
3 and 4 (and the owner's authorization data) are identical to those  
generated by my application:

Even nonce: 30 cd 38 3a 2b 33 9e e9 79 83 ad 22 48 c8 dc 52 78 9f 2a 44

Odd nonce: db 1c c5 46 49 92 55 7d 38 ff 18 ca e8 df ff 5d 0c 01 4c 20

Authorization Boolean: 00

Owner's authorization data: 8c b2 23 7d 06 79 ca 88 db 64 64 ea c6 0d a9 63  
45 51 39 64

The only discrepancy is the SHA-1 hash above. My application computes it to  
be

2b 8e 64 e4 44 b2 57 aa 84 3d dd 10 78 83 0a 31 cb 98 4a ed

whereas the byte string used by the emulator as the first input to the HMAC  
computation in tpm_verify_auth() is

3e 23 f2 c6 9e 6a 29 d2 17 cd cf 02 78 d6 09 08 00 00 00 00

Albeit theoretically possible to be a SHA-1 digest, the byte string above  
is very probably not the direct output from a SHA-1 computation. It would  
seem to be the case that the emulator is using the wrong input.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/tpm-emulator-user/attachments/20101005/1c615abe/attachment.html">https://lists.berlios.de/pipermail/tpm-emulator-user/attachments/20101005/1c615abe/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000168.html">[tpm-emulator-user] TPM_SetCapability possibly broken in 0.7.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#167">[ date ]</a>
              <a href="thread.html#167">[ thread ]</a>
              <a href="subject.html#167">[ subject ]</a>
              <a href="author.html#167">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/tpm-emulator-user">More information about the tpm-emulator-user
mailing list</a><br>
</body></html>
